<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>BigOrange Blog</title>
  
  <subtitle>个人记录</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://biglorange.github.io/"/>
  <updated>2020-11-28T13:36:48.780Z</updated>
  <id>https://biglorange.github.io/</id>
  
  <author>
    <name>BigOrange</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>archlinux 安装并初始化配置 postgresql 9.4.26</title>
    <link href="https://biglorange.github.io/install-postgresql94-archlinux/"/>
    <id>https://biglorange.github.io/install-postgresql94-archlinux/</id>
    <published>2020-11-28T12:01:40.000Z</published>
    <updated>2020-11-28T13:36:48.780Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装并初始化数据库"><a href="#安装并初始化数据库" class="headerlink" title="安装并初始化数据库"></a>安装并初始化数据库</h2><h3 id="安装-postgresql-9-2-46"><a href="#安装-postgresql-9-2-46" class="headerlink" title="安装 postgresql 9.2.46"></a>安装 postgresql 9.2.46</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yay -S postgresql-9.4</span><br><span class="line">sudo pacman -S spostgresql-9.4</span><br></pre></td></tr></table></figure><p>其中 postgresql 9.4 为当前仍然可以直接下载到的 psotgresql 最低版本</p><p>从 postgresql ftp 原始地址下载慢的话可以从 tsinghua 源下载压缩包后进行编译安装</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://mirrors.tuna.tsinghua.edu.cn/postgresql/source/v9.4.26/</span></span><br></pre></td></tr></table></figure><p>下载压缩包后放入 yay 对应的目录即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/orange/.cache/yay/postgresql-9.4</span><br></pre></td></tr></table></figure><p>安装完成后会自动创建 postgres 用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/passwd | grep postgres</span><br><span class="line">postgres:x:88:88:PostgreSQL user:/var/lib/postgres:/bin/bash</span><br></pre></td></tr></table></figure><h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><h4 id="初始化数据库前的准备：用户及路径权限"><a href="#初始化数据库前的准备：用户及路径权限" class="headerlink" title="初始化数据库前的准备：用户及路径权限"></a>初始化数据库前的准备：用户及路径权限</h4><p>默认创建的 psotgres 有密码，但是我没有查到对应密码是多少，先使用 sudo 将原始密码删除</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd -d postgres                </span><br><span class="line">passwd: password expiry information changed.</span><br></pre></td></tr></table></figure><p>重新给 postgres 用户设置密码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd postgers</span><br></pre></td></tr></table></figure><p>然后重复两次密码就可以给 postgres 用户添加上密码了</p><p>进入 postgres 用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">su - postgres       </span><br><span class="line">Password: </span><br><span class="line">mkdir: cannot create directory '/var/lib/postgres/.local': Permission denied</span><br><span class="line">-bash: appendpath: command not found</span><br><span class="line">-bash: appendpath: command not found</span><br><span class="line">-bash: appendpath: command not found</span><br></pre></td></tr></table></figure><p>mkdir 错误是因为 /var/lib/postgres/ 路径 postgres 用户没有权限读写，将该路径所有者修改为 postgres 即可</p><p>appendpath: command not found 错误则是 archlinux 更新带出的问题，使用 zsh 即可解决</p><p>修改路径所有者</p><p>在主用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown postgres:postgres /var/lib/postgres</span><br></pre></td></tr></table></figure><p>将 psotgres 用户的 bash 更换为 zsh 并拷贝主用户下的部分配置文件</p><p>在 postgers 用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[postgres@BiGOranGe ~]$ chsh -s /usr/bin/zsh postgres</span><br><span class="line">Changing shell for postgres.</span><br><span class="line">Password: </span><br><span class="line">Shell changed.</span><br></pre></td></tr></table></figure><p>拷贝主用户的配置文件并修改权限</p><p>主用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -rf .zshrc .oh-my-zsh /var/lib/postgres/</span><br><span class="line">sudo chown postgres:postgres /var/lib/postgres</span><br></pre></td></tr></table></figure><h4 id="初始化数据库-1"><a href="#初始化数据库-1" class="headerlink" title="初始化数据库"></a>初始化数据库</h4><p>进入 postgres 用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres@BiGOranGe:~% initdb --locale en_US.UTF-8 -E UTF8 -D '/var/lib/postgres/data'</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Success. You can now start the database server using:</span><br><span class="line"></span><br><span class="line">    postgres -D /var/lib/postgres/data</span><br><span class="line">or</span><br><span class="line">    pg_ctl -D /var/lib/postgres/data -l logfile start</span><br></pre></td></tr></table></figure><p>返回结果中包含上述内容则为初始化成功</p><h5 id="启动数据库并随开机启动"><a href="#启动数据库并随开机启动" class="headerlink" title="启动数据库并随开机启动"></a>启动数据库并随开机启动</h5><p>主用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start postgresql.service</span><br><span class="line">sudo systemctl enable postgresql.service </span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service → /usr/lib/systemd/system/postgresql.service.</span><br></pre></td></tr></table></figure><h5 id="在数据库中创建用户"><a href="#在数据库中创建用户" class="headerlink" title="在数据库中创建用户"></a>在数据库中创建用户</h5><p>在 postgers 用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres@BiGOranGe:~% createuser -s -d orange</span><br></pre></td></tr></table></figure><p>-s 具有超级用户权限</p><p>-d 具有创建数据库的权限</p><p>orange 则为主用户，这样可以在主用户下直接调用 psql 命令进入数据库</p><h5 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h5><p>主用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createdb orange</span><br></pre></td></tr></table></figure><p>尝试连接数据库</p><p>主用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -d orange</span><br></pre></td></tr></table></figure><p>-d orange 指定要登陆的数据库名，直接 psql 则会尝试登陆与当前用户名相同的数据库</p><h5 id="配置-PGDATA-等环境变量"><a href="#配置-PGDATA-等环境变量" class="headerlink" title="配置 PGDATA 等环境变量"></a>配置 PGDATA 等环境变量</h5><p>postgres 用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/postgres/.zshrc</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PGHOME="/var/lib/postgres"   </span><br><span class="line">export PGDATA="$PGHOME/data"</span><br></pre></td></tr></table></figure><p>添加这两个环境变量并使之生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /var/lib/postgres/.zshrc</span><br></pre></td></tr></table></figure><h5 id="配置数据库可被外部连接"><a href="#配置数据库可被外部连接" class="headerlink" title="配置数据库可被外部连接"></a>配置数据库可被外部连接</h5><p>postgres 用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd $PGDATA</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim postgresql.conf</span><br></pre></td></tr></table></figure><p>添加这一行内容，使 postgresql 可以监听任意 ip 地址的连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses = '*'</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim pg_hba.conf</span><br></pre></td></tr></table></figure><p>添加这一行内容，使任意 ip 都可以连接 postgersql 数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host    all             all             0.0.0.0/0               trust</span><br></pre></td></tr></table></figure><p>修改配置后需要重启数据库才可以生效</p><p>主用户下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart postgresql.service</span><br></pre></td></tr></table></figure><h2 id="pgAdmin3-登陆数据库"><a href="#pgAdmin3-登陆数据库" class="headerlink" title="pgAdmin3 登陆数据库"></a>pgAdmin3 登陆数据库</h2><h3 id="安装-pgAdmin3"><a href="#安装-pgAdmin3" class="headerlink" title="安装 pgAdmin3"></a>安装 pgAdmin3</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yay -S pgadmin3</span><br><span class="line">sudo pacman -S pgadmin3</span><br></pre></td></tr></table></figure><p>同样下载缓慢的话使用 tsinghua 的源进行下载源码包</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://mirrors.tuna.tsinghua.edu.cn/postgresql/pgadmin/pgadmin3/v1.22.2/src/</span></span><br></pre></td></tr></table></figure><p>下载后的源码包放入 pgadmin3 编译目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/orange/.cache/yay/pgadmin3</span><br></pre></td></tr></table></figure><h3 id="建立数据库连接"><a href="#建立数据库连接" class="headerlink" title="建立数据库连接"></a>建立数据库连接</h3><p>Host: 127.0.0.1</p><p>Port: 5432</p><p>sMaintenance DB: orange</p><p>Username: orange</p><p>建立连接后进行数据库操作</p>]]></content>
    
    <summary type="html">
    
      在 archlinux 上安装并初始化配置 postgresql 9.4.26
    
    </summary>
    
    
      <category term="数据库" scheme="https://biglorange.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/tags/Arch-Linux/"/>
    
      <category term="postgresql" scheme="https://biglorange.github.io/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>Archlinux 下 gpg import key 无法与服务器通信</title>
    <link href="https://biglorange.github.io/cannot-import-key-in-cn/"/>
    <id>https://biglorange.github.io/cannot-import-key-in-cn/</id>
    <published>2020-08-17T14:01:59.000Z</published>
    <updated>2020-08-20T13:21:56.631Z</updated>
    
    <content type="html"><![CDATA[<h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>日常更新代码时，python2-mako 作者的公钥更新了，更新软件时需要 import 作者对应的公钥，但是由于国内的网络环境，无法正常通信，导致无法获取公钥，软件包便无法更新</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg: keyserver receive failed: Server indicated a failure</span><br></pre></td></tr></table></figure><p>修改 –keyserver 选项也无法正常工作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 83AF7ACE251C13E6BB7DEFBD330239C1C4DAFEE1</span><br><span class="line">gpg: keyserver receive failed: Server indicated a failure</span><br></pre></td></tr></table></figure><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>寻找一个国内可以正常访问的公钥服务器，例如 ubuntu 的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://keyserver.ubuntu.com/</span><br></pre></td></tr></table></figure><p>浏览器中打开对应网站，搜索对应公钥（前面需要添加 0x）</p><p>点击搜索结果中第一个 pub rsa2048/83af7ace251c13e6bb7defbd330239c1c4dafee1 这条记录</p><p>会获取到一串公钥，此时有两种方式</p><ol><li><p>拷贝完整内容为文本，然后使用 gpg import filename 导入公钥</p></li><li><p>复制链接，使用 curl 下载该链接，使用管道 / 存储为文件导入公钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://keyserver.ubuntu.com/pks/lookup\?op\=get\&amp;search\=0x83af7ace251c13e6bb7defbd330239c1c4dafee1 | gpg --import</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  4694    0  4694    0     0   1755      0 --:--:--  0:00:02 --:--:--  1756</span><br><span class="line">gpg: key 330239C1C4DAFEE1: 4 signatures not checked due to missing keys</span><br><span class="line">gpg: key 330239C1C4DAFEE1: public key <span class="string">"Michael Bayer &lt;classic@zzzcomputing.com&gt;"</span> imported</span><br><span class="line">gpg: Total number processed: 1</span><br><span class="line">gpg:               imported: 1</span><br><span class="line">gpg: no ultimately trusted keys found</span><br></pre></td></tr></table></figure><p>这里显示 imported: 1 则导入 key 成功。</p>]]></content>
    
    <summary type="html">
    
      当在国内网络环境中，需要 gpg --recv-keys key 时，由于网络通信的原因，导致服务器通信失败，进而造成获取公钥失败的一种迂回解决方案。
    
    </summary>
    
    
      <category term="Linux" scheme="https://biglorange.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://biglorange.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>SIP协议</title>
    <link href="https://biglorange.github.io/SIP_protocol/"/>
    <id>https://biglorange.github.io/SIP_protocol/</id>
    <published>2020-08-03T11:43:48.000Z</published>
    <updated>2020-08-26T14:47:00.948Z</updated>
    
    <content type="html"><![CDATA[<p>工作中时常能听到 SIP 协议的名字，但对这个协议始终没有了解，这次便仔细地把这块协议了解一下</p><p>SIP 协议</p><p>SIP（Session Initiation Protocol，会话初始化协议）是由 IETF（Internet EnGineering Task Force，因特网工程任务组）制定的多媒体通信协议，是一个在 IP 网络上进行多媒体通信的应用层控制协议，它被用来创建、修改和中介一个或多个参加者参加的会话进程，与 SDP、TRP/TRCP、DNS 等协议配合，共同完成 IMS 中的会话建立与媒体协商。SIP 协议广泛应用于 CS（Circuit Switched，电路交换）、NGN（Next Generation Network，下一代网络）以及 IMS（IP Mutimedia Subsystem，IP 多媒体子系统）的网络中，可以支持并应用于语音、视频、数据等多媒体业务，同时也可以应用于 Presence（呈现）、Instant Message（即时消息）等特色业务。可以说，有 IP 网络的地方就有 SIP 协议的存在。</p><p>SIP 协议在协议栈中的位置</p><p><img src="/.io//SIP协议在协议栈中的位置_01.bmp" alt=""></p><p>SIP 协议虽然属于应用层协议，然而 SIP 本身不提供任何服务。但是 SIP 是通信的基础，在 SIP 这个通信的基础上可以用来构建不同的服务。SIP 协议在建立和位置多媒体会话中，主要支持如下5个功能：</p><ul><li>检查终端用户的位置。无论被叫放在哪里均能确保呼叫达到被叫放，进行任何描述信息到定位信息的转换；</li><li>检查用户参与会话的意愿程度。参与者在呼叫中能够引入其他用户加入或取消其他用户的连接；</li><li>检查媒体和媒体参数，允许与呼叫有关的组在支持特性上保持一致；</li><li>在呼叫与被叫双方建立会话；</li><li>发送和终止会话，修改会话参数，激活服务等会话管理操作；</li></ul><p>SIP 协议特性</p><ul><li>文本协议：易于调测，结构灵活</li><li>点对点协议：只需要一个相对简单（因此也高度可扩展的）核心网络</li><li>中性的底层传输协议：可用 TCP/UDP（推荐 UDP）</li><li>同时呼叫和媒体信息同时传送：媒体信息的传送由 SDP 传送</li><li>与许多其他协议协同工作，仅涉及通信会话的信令部分（control message）</li></ul><p>SIP 相关协议</p><p>RTP（实时传输协议）</p><p>SDP（会话描述协议）：描述了会话所使用流媒体细节，如：使用哪个 IP 端口，采用哪种编解码器等等</p><p>SIP 协议的一个典型用途：</p><p>SIP “会话”传输一些简单的经过封包的实时传输协议。RTP 本身才是语音或视频的载体。</p><h2 id="业务过程和协议流程"><a href="#业务过程和协议流程" class="headerlink" title="业务过程和协议流程"></a>业务过程和协议流程</h2><p>注册流程</p><pre class="mermaid">sequenceDiagramtitle:SIP 注册流程participant 终端代理 Aparticipant 代理服务器终端代理 A -->> 代理服务器:REGISTER(1)代理服务器 -->> 终端代理 A:401(2)终端代理 A -->> 代理服务器:REGISTER(3)代理服务器 -->> 终端代理 A:200 OK(4)</pre><ol><li>用户首次试呼时，终端代理 A 向代理服务器发送 REGISTER 注册请求；</li><li>代理服务器通过后端认证/计费中心获知用户信息不再数据库中，便向终端代理回送401 Unauthorized 质询消息，其中包含安全认证所需的令牌；</li><li>终端代理提示用户输入其标识和密码后，根据安全认证令牌将其加密后，再次用 REGISTER 消息报告给代理服务器；</li><li>代理服务器将 REGISTER 消息中的用户信息解密，通过认证/计费中心验证其合法后，将该用户信息登记到数据库中，并向终端代理返回成功响应消息200 OK。</li></ol><p>注销流程</p><pre class="mermaid">sequenceDiagramparticipant 终端代理participant 代理服务器终端代理 -->> 代理服务器:REGISTER(1)代理服务器 -->> 终端代理:200 OK(2)</pre><ol><li>终端向代理服务器发送 REGISTER 消息注销，其中 EXPIRE 字段设置为0；</li><li>代理服务器在收到后送回 200 OK 响应，并将数据库中的用户有关消息注销。</li></ol><p>基本呼叫建立过程</p><pre class="mermaid">sequenceDiagramparticipant 终端代理 Aparticipant 代理服务器participant 终端代理 B终端代理 A -->> 代理服务器: Invite(1)代理服务器 -->> 终端代理 B: Invite(2)代理服务器 -->> 终端代理 A: 100 Trying(3)终端代理 B -->> 代理服务器: 100 Trying(4)终端代理 B -->> 代理服务器: 180 Ringing(5)代理服务器 -->> 终端代理 A: 180 Ringing(6)终端代理 B -->> 代理服务器: 200 OK(7)代理服务器 -->> 终端代理 A: 200 OK(8)终端代理 A -->> 代理服务器: ACK(9)代理服务器 -->> 终端代理 B: ACK(10)终端代理 B --> 终端代理 A: 通话(11)</pre><ol><li>用户摘机发起一路呼叫，终端代理 A 向该区域的代理服务器发起 Invite 请求；</li><li>代理服务器通过认证/计费中心确认用户认证已通过后，检查请求消息中的 Via 头域中是否已包含其地址。若已包含，说明发生环回，返回只是错误的应答；若没有问题，代理服务器在请求消息的 Via 头域插入自身地址，并向 Invite 消息的 To 头域所指示的被叫终端代理 B 发送 Invite 请求；</li><li>代理服务器向终端代理 A 发送呼叫处理中的应答消息：100 Trying（防止请求发送到终端代理 B 时，终端代理 A 已经超时）；</li><li>终端代理 B 向代理服务器发送呼叫处理中的应答消息：100 Trying；</li><li>终端代理 B 指示被叫用户振铃，用户振铃后向代理服务器发送 180 Ringing 振铃消息；</li><li>代理服务器向终端代理 A 转发被叫用户振铃消息；</li><li>被叫用户摘机，终端代理 B 向代理服务器返回表示连接成功的应答 200 OK；</li><li>代理服务器向终端代理 A 转发该成功指示 200 OK；</li><li>终端代理 A 收到信息后，向代理服务器发送 ACK 消息进行确认；</li><li>代理服务器将 ACK 确认消息转发给终端代理 B；</li><li>主被叫用户之间建立通信连接，开始通话。</li></ol><p>正常呼叫释放流程</p><pre class="mermaid">sequenceDiagramparticipant 终端代理 Aparticipant 代理服务器participant 终端代理 B终端代理 A -->> 终端代理 B: 通话(1)终端代理 B -->> 代理服务器: Bye(2)代理服务器 -->> 终端代理 A: Bye(3)终端代理 A -->> 代理服务器: 200 OK(4)代理服务器 -->> 终端代理 B: 200 OK(5)</pre><ol><li>正常呼叫</li><li>用户通话结束后，被叫用户挂机，终端代理 B 向代理服务器发送 Bye 消息；</li><li>代理服务器转发 Bye 消息至终端代理 A,同时向认证、计费中心发送用户通话的详细信息，请求计费；</li><li>主叫用户挂机后，终端代理 A 向代理服务器发送确认挂断相应信息 200 OK；</li><li>代理服务器转发响应信息 200 OK.</li></ol><p>会话更改流程</p><p>To be continued…</p><hr><p>参考文献</p><p>[1]. <a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-sip-intro/index.html" target="_blank" rel="noopener">会话初始化协议（SIP）简介及应用</a></p><p>[2]. <a href="https://www.cnblogs.com/xiaxveliang/p/12434170.html" target="_blank" rel="noopener">SIP协议详解</a></p><p>[3]. <a href="https://yq.aliyun.com/articles/243203" target="_blank" rel="noopener">SIP 协议呼叫流程详解</a></p>]]></content>
    
    <summary type="html">
    
      SIP(Session Initiation Protocol)会话初始化协议，是一个在 IP 网络上进行多媒体通信的应用层控制协议。
    
    </summary>
    
    
      <category term="计算机网络" scheme="https://biglorange.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="协议" scheme="https://biglorange.github.io/tags/%E5%8D%8F%E8%AE%AE/"/>
    
      <category term="计算机网络" scheme="https://biglorange.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
      <category term="网络协议" scheme="https://biglorange.github.io/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/"/>
    
  </entry>
  
  <entry>
    <title>命令行设置触摸板轻触为点击</title>
    <link href="https://biglorange.github.io/%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%AE%BE%E7%BD%AE%E8%A7%A6%E6%91%B8%E6%9D%BF%E8%BD%BB%E8%A7%A6%E4%B8%BA%E7%82%B9%E5%87%BB/"/>
    <id>https://biglorange.github.io/%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%AE%BE%E7%BD%AE%E8%A7%A6%E6%91%B8%E6%9D%BF%E8%BD%BB%E8%A7%A6%E4%B8%BA%E7%82%B9%E5%87%BB/</id>
    <published>2019-12-25T15:16:09.000Z</published>
    <updated>2020-08-26T14:30:14.738Z</updated>
    
    <content type="html"><![CDATA[<h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>在 Linux 下使用触摸板的时候总是需要重按下去才是点击操作，个人更喜欢轻触点击的中操作方式，网上搜索基本都是依靠 GDM/KDM 这种桌面管理其实现的修改方式，自己使用的 i3-wm 的平铺式桌面，基本上就只有修改对应的配置文件或者命令行方式了，就研究了一番，把对应的命令操作记录下来，在 Archlinux 上我用到的就 xinput 这一条命令了。</p><h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><p>首先查看设备列表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">xinput           </span><br><span class="line">⎡ Virtual core pointer                    id=2[master pointer  (3)]</span><br><span class="line">⎜   ↳ Virtual core XTEST pointer              id=4[slave  pointer  (2)]</span><br><span class="line">⎜   ↳     Mouse                               id=16[slave  pointer  (2)]</span><br><span class="line">⎜   ↳     Touchpad                            id=17[slave  pointer  (2)]</span><br><span class="line">⎜   ↳ SONiX USB DEVICE Consumer Control       id=11[slave  pointer  (2)]</span><br><span class="line">⎜   ↳ USB Optical Mouse                       id=21[slave  pointer  (2)]</span><br><span class="line">⎣ Virtual core keyboard                   id=3[master keyboard (2)]</span><br><span class="line">    ↳ Virtual core XTEST keyboard             id=5[slave  keyboard (3)]</span><br><span class="line">    ↳ Power Button                            id=6[slave  keyboard (3)]</span><br><span class="line">    ↳ Video Bus                               id=7[slave  keyboard (3)]</span><br><span class="line">    ↳ Video Bus                               id=8[slave  keyboard (3)]</span><br><span class="line">    ↳ Power Button                            id=9[slave  keyboard (3)]</span><br><span class="line">    ↳ Sleep Button                            id=10[slave  keyboard (3)]</span><br><span class="line">    ↳ HD WebCam: HD WebCam                    id=18[slave  keyboard (3)]</span><br><span class="line">    ↳ AT Translated Set 2 keyboard            id=19[slave  keyboard (3)]</span><br><span class="line">    ↳ Acer WMI hotkeys                        id=20[slave  keyboard (3)]</span><br><span class="line">    ↳ SONiX USB DEVICE Consumer Control       id=12[slave  keyboard (3)]</span><br><span class="line">    ↳ SONiX USB DEVICE Keyboard               id=13[slave  keyboard (3)]</span><br><span class="line">    ↳ SONiX USB DEVICE System Control         id=14[slave  keyboard (3)]</span><br><span class="line">    ↳ SONiX USB DEVICE                        id=15[slave  keyboard (3)]</span><br></pre></td></tr></table></figure><p>其中 id=16 的设备则为笔记本上的触摸板模拟鼠标</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">xinput list-props 17</span><br><span class="line">Device <span class="string">'    Touchpad'</span>:</span><br><span class="line">Device Enabled (169):1</span><br><span class="line">Coordinate Transformation Matrix (171):1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000</span><br><span class="line">libinput Tapping Enabled (324):0</span><br><span class="line">libinput Tapping Enabled Default (325):0</span><br><span class="line">libinput Tapping Drag Enabled (326):1</span><br><span class="line">libinput Tapping Drag Enabled Default (327):1</span><br><span class="line">libinput Tapping Drag Lock Enabled (328):0</span><br><span class="line">libinput Tapping Drag Lock Enabled Default (329):0</span><br><span class="line">libinput Tapping Button Mapping Enabled (330):1, 0</span><br><span class="line">libinput Tapping Button Mapping Default (331):1, 0</span><br><span class="line">libinput Natural Scrolling Enabled (304):0</span><br><span class="line">libinput Natural Scrolling Enabled Default (305):0</span><br><span class="line">libinput Disable While Typing Enabled (332):1</span><br><span class="line">libinput Disable While Typing Enabled Default (333):1</span><br><span class="line">libinput Scroll Methods Available (308):1, 1, 0</span><br><span class="line">libinput Scroll Method Enabled (309):1, 0, 0</span><br><span class="line">libinput Scroll Method Enabled Default (310):1, 0, 0</span><br><span class="line">libinput Click Methods Available (334):1, 1</span><br><span class="line">libinput Click Method Enabled (335):1, 0</span><br><span class="line">libinput Click Method Enabled Default (336):1, 0</span><br><span class="line">libinput Middle Emulation Enabled (315):0</span><br><span class="line">libinput Middle Emulation Enabled Default (316):0</span><br><span class="line">libinput Accel Speed (317):0.000000</span><br><span class="line">libinput Accel Speed Default (318):0.000000</span><br><span class="line">libinput Left Handed Enabled (322):0</span><br><span class="line">libinput Left Handed Enabled Default (323):0</span><br><span class="line">libinput Send Events Modes Available (289):1, 1</span><br><span class="line">libinput Send Events Mode Enabled (290):0, 0</span><br><span class="line">libinput Send Events Mode Enabled Default (291):0, 0</span><br><span class="line">Device Node (292):<span class="string">"/dev/input/event8"</span></span><br><span class="line">Device Product ID (293):1739, 10608</span><br><span class="line">libinput Drag Lock Buttons (306):&lt;no items&gt;</span><br><span class="line">libinput Horizontal Scroll Enabled (307):1</span><br></pre></td></tr></table></figure><p>其中属性 libinput Tapping Enabled (324) 和 325 则是轻触点击，当前值均为0，被禁用，将对应值设置为1即可启用轻触点击。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xinput <span class="built_in">set</span>-prop 17 324 1</span><br></pre></td></tr></table></figure><p>device id 会在重启后变更，因此可以使用对应字符串获取对应 device id，然后再获取到对应的属性，将其开启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deviceid=`xinput | grep <span class="string">"Touchpad"</span> | awk -F<span class="string">" "</span> &#123;<span class="string">'print $4'</span>&#125; | awk -F<span class="string">"="</span> &#123;<span class="string">'print $2'</span>&#125;`</span><br></pre></td></tr></table></figure><p>获取到 device id。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">propid=`xinput list-props <span class="variable">$&#123;deviceid&#125;</span> | grep <span class="string">"libinput Tapping Enabled ("</span> | awk -F<span class="string">" "</span> &#123;<span class="string">'print $4'</span>&#125;</span><br><span class="line">propid=<span class="variable">$&#123;propid:1:3&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$propid</span></span><br><span class="line">324</span><br></pre></td></tr></table></figure><p>再获取到属性 id。</p><p>接着就可以直接对 device id 和其对应的属性 id 设置值。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xinput <span class="built_in">set</span>-prop <span class="variable">$&#123;deviceid&#125;</span> <span class="variable">$&#123;propid&#125;</span> 1</span><br></pre></td></tr></table></figure><p>然后把这些组成 shell 脚本，再添加开机启动任务就可以生效了。</p>]]></content>
    
    <summary type="html">
    
      在命令行下设置触摸板轻触为点击
    
    </summary>
    
    
      <category term="Linux" scheme="https://biglorange.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://biglorange.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>利用Git rebase使提交记录清晰明了</title>
    <link href="https://biglorange.github.io/use_rebase_to_make_git_log_clear/"/>
    <id>https://biglorange.github.io/use_rebase_to_make_git_log_clear/</id>
    <published>2019-12-17T15:35:45.000Z</published>
    <updated>2019-12-17T15:35:46.233Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Linux 下降低 CPU 电压</title>
    <link href="https://biglorange.github.io/downgrade_cpu_voltage_on_linux/"/>
    <id>https://biglorange.github.io/downgrade_cpu_voltage_on_linux/</id>
    <published>2019-12-15T07:09:29.000Z</published>
    <updated>2019-12-15T07:29:14.601Z</updated>
    
    <content type="html"><![CDATA[<h4 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h4><p>python-undervolt</p><h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><p>sudo undervolt –core -100 –cache -100</p><p>使用方式注意点</p><p>核心和 cache 的电压要降低相同的数值，同时 CPU 会自动设置降压为最接近设定值的数值</p><p>比如我的降压设置为 -85mV，系统自动匹配值为-84.96mV</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">temperature target: -3 (97C)</span><br><span class="line">core: -84.96 mV</span><br><span class="line">gpu: 0.0 mV</span><br><span class="line">cache: -84.96 mV</span><br><span class="line">uncore: 0.0 mV</span><br><span class="line">analogio: 0.0 mV</span><br></pre></td></tr></table></figure><p>降低电压会导致系统不稳定，过低会造成死机，重启后会自动恢复为默认值，当降低的电压可以稳定运行时，可以将其配置为启动时自动生效</p><p>要设置降压一直生效，需要配置对应的自启动任务</p><h4 id="设置降压在系统自启动时生效"><a href="#设置降压在系统自启动时生效" class="headerlink" title="设置降压在系统自启动时生效"></a>设置降压在系统自启动时生效</h4><p>创建 systemd 服务</p><p><code>/etc/systemd/system/undervolt.service</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=undervolt</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/usr/bin/undervolt -v --core -85 --cache -85</span><br></pre></td></tr></table></figure><p>然后创建一个定时器 <code>/etc/systemd/system/undervolt.timer</code> 来周期性触发任务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Apply undervolt settings</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">Unit=undervolt.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> Wait 2 minutes after boot before first applying</span></span><br><span class="line">OnBootSec=2min</span><br><span class="line"><span class="meta">#</span><span class="bash"> Run every 30 seconds</span></span><br><span class="line">OnUnitActiveSec=30</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>启用定时器和服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable undervolt.timer</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Arch Linux 下使用 undervolt 降低 CPU 电压以减小发热
    
    </summary>
    
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/categories/Arch-Linux/"/>
    
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/tags/Arch-Linux/"/>
    
      <category term="CPU" scheme="https://biglorange.github.io/tags/CPU/"/>
    
  </entry>
  
  <entry>
    <title>桌面无线进化 连接蓝牙鼠标和键盘</title>
    <link href="https://biglorange.github.io/%E6%A1%8C%E9%9D%A2%E6%97%A0%E7%BA%BF%E8%BF%9B%E5%8C%96-%E8%BF%9E%E6%8E%A5%E8%93%9D%E7%89%99%E9%BC%A0%E6%A0%87%E5%92%8C%E9%94%AE%E7%9B%98/"/>
    <id>https://biglorange.github.io/%E6%A1%8C%E9%9D%A2%E6%97%A0%E7%BA%BF%E8%BF%9B%E5%8C%96-%E8%BF%9E%E6%8E%A5%E8%93%9D%E7%89%99%E9%BC%A0%E6%A0%87%E5%92%8C%E9%94%AE%E7%9B%98/</id>
    <published>2019-12-15T06:22:31.000Z</published>
    <updated>2019-12-15T07:05:20.018Z</updated>
    
    <content type="html"><![CDATA[<h4 id="鼠标键盘"><a href="#鼠标键盘" class="headerlink" title="鼠标键盘"></a>鼠标键盘</h4><p>键盘：RK 61 Cherry 茶轴 黑色</p><p>鼠标：达尔优 LM108 垂直人体工学鼠标</p><p>软件包： bluetoorhctl</p><h4 id="连接鼠标"><a href="#连接鼠标" class="headerlink" title="连接鼠标"></a>连接鼠标</h4><p>打开鼠标开关</p><p>达尔优 LM108 底面左上角有一个黑色按钮，为蓝牙配对按钮</p><p>长按进入蓝牙配对模式</p><p>电脑上使用 bluetoothctl 进行蓝牙管理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bluetoothctl</span><br><span class="line">Agent registered</span><br><span class="line">[CHG] Controller 60:57:18:1C:C1:8F Pairable: yes</span><br><span class="line"><span class="meta">[bluetooth]#</span><span class="bash"> scan on</span></span><br><span class="line">Discovery started</span><br></pre></td></tr></table></figure><p>当扫描到对应蓝牙设备的 mac 时，使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pair &lt;mac-of-mouse&gt;</span><br></pre></td></tr></table></figure><p>进行配对连接</p><p>此时会弹出提示框输入 yes 以确认配对设备</p><p>配对之后输入 connect <mac-of-moouse> 连接鼠标</mac-of-moouse></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect &lt;mac-of-mouse&gt;</span><br></pre></td></tr></table></figure><p>至此鼠标连接成功。</p><p>接下来以蓝牙方式连接键盘</p><h4 id="连接键盘"><a href="#连接键盘" class="headerlink" title="连接键盘"></a>连接键盘</h4><p>去 RK 官网查看 RK 61 双模键盘使用方式</p><p>我这里为第一版， Tab 和 P 键上都有镭射标记</p><p>Fn + Tab 为蓝牙有线连接方式切换，出厂默认为蓝牙连接方式</p><p>Fn + P 进入蓝牙配对模式</p><p>首先打开键盘背部开关开启键盘</p><p>出厂默认为蓝牙连接方式，则按下 Fn + P 进入蓝牙配对模式，此时 P 键连续闪烁</p><p>在电脑上进入 bluetoothctl 进行蓝牙配对</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bluetoothctl</span><br><span class="line">scan on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 扫描到蓝牙键盘后使用 pair &lt;mac-of-keyboard&gt; 进行配对</span></span><br><span class="line">pair &lt;mac-of-keyboard&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入 yes 以确认配对</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配对成功之后使用 connect &lt;mac-of-keyboard&gt; 进行连接</span></span><br><span class="line">connect &lt;mac-of-keyboard&gt;</span><br></pre></td></tr></table></figure><p>至此键盘和鼠标的连接完成</p><p>接下来进行鼠标延迟的优化</p><h4 id="鼠标延迟优化"><a href="#鼠标延迟优化" class="headerlink" title="鼠标延迟优化"></a>鼠标延迟优化</h4><p>修改鼠标轮询率</p><p>查看蓝牙鼠标 mac 地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bluetoothctl</span><br><span class="line">Agent registered</span><br><span class="line">[CHG] Controller 60:57:18:1C:C1:8F Pairable: yes</span><br><span class="line">[RK-Bluetooth keyboard]# devices</span><br><span class="line">Device DC:2C:26:D0:08:02 RK-Bluetooth keyboard</span><br><span class="line">Device FA:0C:38:6A:EC:CE LM108 Bluetooth</span><br></pre></td></tr></table></figure><p>查看系统蓝牙适配器 mac 地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[RK-Bluetooth keyboard]# list</span><br><span class="line">Controller 60:57:18:1C:C1:8F BiGOranGe [default]</span><br></pre></td></tr></table></figure><p>var 下目录需要超级管理员权限才可以查看修改</p><p>在超级管理员状态下修改 <code>/var/lib/bluetooth/&lt;mac-of-adaptor&gt;/&lt;mac-of-mouse&gt;/info</code>添加/修改以下字段</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ConnectionParameters]</span><br><span class="line">MinInterval=6</span><br><span class="line">MaxInterval=9</span><br><span class="line">Latency=44</span><br><span class="line">Timeout=216</span><br></pre></td></tr></table></figure><p>修改之前的值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ConnectionParameters]</span><br><span class="line">MinInterval=6</span><br><span class="line">MaxInterval=9</span><br><span class="line">Latency=100</span><br><span class="line">Timeout=600</span><br></pre></td></tr></table></figure><p>可以自己根据自己的需求调节这两个值进行优化，以达到自己满意的状态</p><h4 id="设置蓝牙自动连接"><a href="#设置蓝牙自动连接" class="headerlink" title="设置蓝牙自动连接"></a>设置蓝牙自动连接</h4><p>修改/添加 <code>/etc/bluetooth/main.conf</code>的<code>[Policy]</code>下添加<code>AutoEnable=true</code>将蓝牙设备设置为开机自动连接</p>]]></content>
    
    <summary type="html">
    
      桌面无线化，切换无线鼠标达尔优 LM108，双模机械键盘 RK61 Cherry 茶轴
    
    </summary>
    
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/categories/Arch-Linux/"/>
    
      <category term="peripherals" scheme="https://biglorange.github.io/categories/Arch-Linux/peripherals/"/>
    
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/tags/Arch-Linux/"/>
    
      <category term="bluetooth" scheme="https://biglorange.github.io/tags/bluetooth/"/>
    
      <category term="keyboard" scheme="https://biglorange.github.io/tags/keyboard/"/>
    
      <category term="mouse" scheme="https://biglorange.github.io/tags/mouse/"/>
    
  </entry>
  
  <entry>
    <title>显卡驱动作死（续）显卡控制切换脚本化</title>
    <link href="https://biglorange.github.io/%E6%98%BE%E5%8D%A1%E9%A9%B1%E5%8A%A8%E4%BD%9C%E6%AD%BB%EF%BC%88%E7%BB%AD%EF%BC%89%E6%98%BE%E5%8D%A1%E6%8E%A7%E5%88%B6%E5%88%87%E6%8D%A2%E8%84%9A%E6%9C%AC%E5%8C%96/"/>
    <id>https://biglorange.github.io/%E6%98%BE%E5%8D%A1%E9%A9%B1%E5%8A%A8%E4%BD%9C%E6%AD%BB%EF%BC%88%E7%BB%AD%EF%BC%89%E6%98%BE%E5%8D%A1%E6%8E%A7%E5%88%B6%E5%88%87%E6%8D%A2%E8%84%9A%E6%9C%AC%E5%8C%96/</id>
    <published>2019-05-12T14:09:21.000Z</published>
    <updated>2019-05-12T15:17:11.414Z</updated>
    
    <content type="html"><![CDATA[<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>首先确保直接使用 nVidia 闭源驱动能够正常工作，同时 bumblebee 也是能够正常工作的。</p><p>系统版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">                  -`                    orange@BiGOranGe </span><br><span class="line">                 .o+`                   ---------------- </span><br><span class="line">                `ooo/                   OS: Arch Linux x86_64 </span><br><span class="line">               `+oooo:                  Host: Aspire VN7-591G V1.15 </span><br><span class="line">              `+oooooo:                 Kernel: 5.0.13-arch1-1-ARCH </span><br><span class="line">              -+oooooo+:                Uptime: 2 hours, 4 mins </span><br><span class="line">            `/:-:++oooo+:               Packages: 2054 (pacman) </span><br><span class="line">           `/++++/+++++++:              Shell: zsh 5.7.1 </span><br><span class="line">          `/++++++++++++++:             Resolution: 1920x1080 </span><br><span class="line">         `/+++ooooooooooooo/`           DE: Deepin </span><br><span class="line">        ./ooosssso++osssssso+`          WM: Mutter(DeepinGala) </span><br><span class="line">       .oossssso-````/ossssss+`         Theme: Adapta [GTK2/3] </span><br><span class="line">      -osssssso.      :ssssssso.        Icons: Numix-Circle [GTK2/3] </span><br><span class="line">     :osssssss/        osssso+++.       Terminal: deepin-terminal </span><br><span class="line">    /ossssssss/        +ssssooo/-       Terminal Font: Noto Mono <span class="keyword">for</span> Powerline 12 </span><br><span class="line">  `/ossssso+/:-        -:/+osssso+-     CPU: Intel i5-4210H (4) @ 3.500GHz </span><br><span class="line"> `+sso+:-`                 `.-/+oso:    GPU: Intel 4th Gen Core Processor </span><br><span class="line">`++:.                           `-/+/   GPU: NVIDIA GeForce GTX 860M </span><br><span class="line">.`                                 `/   Memory: 2633MiB / 7898MiB</span><br></pre></td></tr></table></figure><p>nVidia 版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Sun May 12 23:14:07 2019       </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 418.74       Driver Version: 418.74       CUDA Version: 10.1     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  GeForce GTX 860M    Off  | 00000000:01:00.0 Off |                  N/A |</span><br><span class="line">| N/A   49C    P0    N/A /  N/A |      5MiB /  2004MiB |      0%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">                                                                               </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                       GPU Memory |</span><br><span class="line">|  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0     11362      G   /usr/lib/Xorg                                  4MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvim /usr/<span class="built_in">local</span>/bin/nvch.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">/usr/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">function</span>:change nvidia driver,bumblebee or use nvidia driver directively</span></span><br><span class="line">if [[ $1 == "n" ]]  # use nvidia driver</span><br><span class="line">then</span><br><span class="line">sudo systemctl disable bumblebeed     # 取消 bumblebee 的开机启动</span><br><span class="line">echo  | yay -Rnsc bumblebee           # 卸载 bumblebee</span><br><span class="line">echo "Bumblebee was removed"</span><br><span class="line">sudo cp /etc/X11/xorg.conf.bak /etc/X11/xorg.conf      # 直接使用 nVidia 驱动需要配置 xorg</span><br><span class="line">echo "xorg.conf was created"</span><br><span class="line">sudo cp /home/orange/Software/desktop/nvidia-settings-nvidia.desktop /usr/share/applications/nvidia-settings.desktop   # 这里是直接使用 nVidia 时 nvidia-setting 的打开方式</span><br><span class="line">echo "desktop file created"</span><br><span class="line">sudo sed -i 's/^VDPAU_DRIVER=va_gl/VDPAU_DRIVER=nvidia/' /etc/environment# 环境变量设置 vdpau 为 nVidia</span><br><span class="line">echo "environment VDPAU_DRIVER now is nvidia"</span><br><span class="line"><span class="meta">#</span><span class="bash">sed -i <span class="string">'s/^#hw=vdpau/hw=vdpau/'</span> /home/orange/.config/mpv/mpv.conf    <span class="comment"># 设置 mpv 使用 nVidia 显卡硬解码，缓解 CPU 占用率</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">sed -i <span class="string">'s/^#profile=gpu-hq/profile=gpu-hq/'</span> /home/orange/.config/mpv/mpv.conf</span></span><br><span class="line">sed -i 's/^#gpu-api=vulkan/gpu-api=vulkan/' /home/orange/.config/mpv/mpv.conf</span><br><span class="line">sed -i 's/^#vo=vdpau/vo=vdpau/' /home/orange/.config/mpv/mpv.conf</span><br><span class="line">echo "mpv.conf now is nVidia"</span><br><span class="line">elif [[ $1 == "b" ]]</span><br><span class="line">then </span><br><span class="line">echo | yay -S bumblebee primus lib32-primus          # 安装 bumblebee 及 primus</span><br><span class="line">echo "Bumblebee &amp; primus was installed"</span><br><span class="line">sudo systemctl enable bumblebeed                     # 开机启动 bumblebee</span><br><span class="line">echo "Bumblebee.service was enabled"</span><br><span class="line">sudo mv /etc/X11/xorg.conf /etc/X11/xorg.conf/bak         # bumblebee 会自动管理 xorg，所以将 xorg 配置文件直接备份，以备在切换为直接使用 nVidia 驱动时使用</span><br><span class="line">echo "xorg.conf was deleted"</span><br><span class="line">sudo cp /home/orange/Software/desktop/nvidia-settings-bumblebee.desktop /usr/share/applications/nvidia-settings.desktop  # 这里是使用 bumblebee 时 nvidia-setting 的打开方式</span><br><span class="line">echo "desktop file created"</span><br><span class="line">sudo sed -i 's/^VDPAU_DRIVER=nvidia/VDPAU_DRIVER=va_gl/g' /etc/environment    # 设置环境变量 vdpau 为 intel 集成显卡</span><br><span class="line">echo "environment VDPAU_DRIVER now is #"</span><br><span class="line"><span class="meta">#</span><span class="bash">sed -i <span class="string">'s/^hw=vdpau/#hw=vdpau/'</span> /home/orange/.config/mpv/mpv.conf        <span class="comment"># 取消 mpv 用 nVidia 解码的方式，否则 mpv 会无法打开</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">sed -i <span class="string">'s/^profile=gpu-hq/#profile=gpu-hq/'</span> /home/orange/.config/mpv/mpv.conf</span></span><br><span class="line">sed -i 's/^gpu-api=vulkan/#gpu-api=vulkan/' /home/orange/.config/mpv/mpv.conf </span><br><span class="line">sed -i 's/^vo=vdpau/#vo=vdpau/' /home/orange/.config/mpv/mpv.conf</span><br><span class="line">echo "mpv.conf now is #"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>两个不同的 desktop 文件内容：</p><p>nvidia-settings-bumblebee.desktop</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Type=Application</span><br><span class="line">Encoding=UTF-8</span><br><span class="line">Name=NVIDIA X Server Settings Bumblebee</span><br><span class="line">Comment=Configure NVIDIA X Server Settings</span><br><span class="line">Exec=optirun -b none /usr/bin/nvidia-settings -c :8</span><br><span class="line">Icon=/usr/share/pixmaps/nvidia-settings.png</span><br><span class="line">Categories=__NVIDIA_SETTINGS_DESKTOP_CATEGORIES__</span><br><span class="line"></span><br><span class="line"><span class="comment"># Translations provided by Sun Microsystems</span></span><br><span class="line">Name[de]=NVIDIA X-Server-Einstellungen</span><br><span class="line">Name[es]=Valores de configuración del servidor NVIDIA X</span><br><span class="line">Name[fr]=Paramètres du serveur X NVIDIA</span><br><span class="line">Name[it]=NVIDIA X Server Settings</span><br><span class="line">Name[ja]=NVIDIA X サーバー設定</span><br><span class="line">Name[ko]=NVIDIA X 서버 설정</span><br><span class="line">Name[pt_BR]=Configurações <span class="keyword">do</span> NVIDIA X Server</span><br><span class="line">Name[zh_CN]=NVIDIA X 服务器设置</span><br><span class="line">Name[zh_HK]=NVIDIA X 伺服器設定</span><br><span class="line">Name[zh_TW]=NVIDIA X 伺服器設定</span><br><span class="line">Comment[de]=Konfigurieren der NVIDIA X-Server-Einstellungen</span><br><span class="line">Comment[es]=Establezca los valores de configuración del servidor NVIDIA X</span><br><span class="line">Comment[fr]=Configurer les paramètres du serveur X NVIDIA</span><br><span class="line">Comment[it]=Configura NVIDIA X Server Settings</span><br><span class="line">Comment[ja]=NVIDIA X サーバー設定を構成します</span><br><span class="line">Comment[ko]=NVIDIA X 서버 설정 구성</span><br><span class="line">Comment[pt_BR]=Definir &amp;configurações de gerenciamento de usuário...</span><br><span class="line">Comment[zh_CN]=配置 NVIDIA X 服务器设置</span><br><span class="line">Comment[zh_HK]=配置 NVIDIA X 伺服器設定</span><br><span class="line">Comment[zh_TW]=配置 NVIDIA X 伺服器設定</span><br></pre></td></tr></table></figure><p>nvidia-settings-nvidia.desktop</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Categories=__NVIDIA_SETTINGS_DESKTOP_CATEGORIES__</span><br><span class="line">Comment=Configure NVIDIA X Server Settings</span><br><span class="line">Comment[de]=Konfigurieren der NVIDIA X-Server-Einstellungen</span><br><span class="line">Comment[es]=Establezca los valores de configuración del servidor NVIDIA X</span><br><span class="line">Comment[fr]=Configurer les paramètres du serveur X NVIDIA</span><br><span class="line">Comment[it]=Configura NVIDIA X Server Settings</span><br><span class="line">Comment[ja]=NVIDIA X サーバー設定を構成します</span><br><span class="line">Comment[ko]=NVIDIA X 서버 설정 구성</span><br><span class="line">Comment[pt_BR]=Definir &amp;configurações de gerenciamento de usuário...</span><br><span class="line">Comment[zh_CN]=配置 NVIDIA X 服务器设置</span><br><span class="line">Comment[zh_HK]=配置 NVIDIA X 伺服器設定</span><br><span class="line">Comment[zh_TW]=配置 NVIDIA X 伺服器設定</span><br><span class="line">Encoding=UTF-8</span><br><span class="line">Exec=/usr/bin/nvidia-settings</span><br><span class="line">Icon=/usr/share/pixmaps/nvidia-settings.png</span><br><span class="line">Name=NVIDIA X Server Settings Nvidia</span><br><span class="line">Name[de]=NVIDIA X-Server-Einstellungen</span><br><span class="line">Name[es]=Valores de configuración del servidor NVIDIA X</span><br><span class="line">Name[fr]=Paramètres du serveur X NVIDIA</span><br><span class="line">Name[it]=NVIDIA X Server Settings</span><br><span class="line">Name[ja]=NVIDIA X サーバー設定</span><br><span class="line">Name[ko]=NVIDIA X 서버 설정</span><br><span class="line">Name[pt_BR]=Configurações <span class="keyword">do</span> NVIDIA X Server</span><br><span class="line">Name[zh_CN]=NVIDIA X 服务器设置</span><br><span class="line">Name[zh_HK]=NVIDIA X 伺服器設定</span><br><span class="line">Name[zh_TW]=NVIDIA X 伺服器設定</span><br><span class="line">Type=Application</span><br></pre></td></tr></table></figure><p>赋予脚本可执行权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/nvch.sh</span><br></pre></td></tr></table></figure><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvch n     <span class="comment"># 切换为直接使用 nVidia 闭源驱动的方式</span></span><br><span class="line">nvch b     <span class="comment"># 切换为使用 bumblebee 的省电方式</span></span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>切换显卡驱动方式之后需要重启才能生效</p><h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>脚本中 mpv 配置那一段是个人需要所配置的，因为 CPU 集显性能在现在看有一点不够用，导致看较大（5GB以上）视频会掉帧，同时整个电脑会卡顿，CPU 被吃满，所以此时需要使用 nVidia 显卡来打开 mpv。在此之前也有尝试过使用 bumblebee 的方式来通过 primusrun 或者 optirun 来给 mpv 加速获取高性能，但因为 mpv 使用的方式无法使用 bumblebee 来资持的，所以就想到了这么一个算是比较难看的办法。</p>]]></content>
    
    <summary type="html">
    
      通常情况下并不需要独立显卡的性能，只需要有一个集成显卡作为显示输出，同时将独立显卡关闭以省电，但是有时又需要独立显卡的性能来干一些工作，同时自己手动尝试了一下在 nVidia 显卡常开和使用 bumblebee 之间切换是可行的，就将两者之间的切换做成了命令集成，只是很简单的命令集成，没有很高深的脚本化，仅为自用就可以的程度。
    
    </summary>
    
    
      <category term="nVidia" scheme="https://biglorange.github.io/categories/nVidia/"/>
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/categories/nVidia/Arch-Linux/"/>
    
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/tags/Arch-Linux/"/>
    
      <category term="nvidia" scheme="https://biglorange.github.io/tags/nvidia/"/>
    
      <category term="nvidia-primes" scheme="https://biglorange.github.io/tags/nvidia-primes/"/>
    
      <category term="bumblebee" scheme="https://biglorange.github.io/tags/bumblebee/"/>
    
  </entry>
  
  <entry>
    <title>禁用笔记本内置键盘，防止误触</title>
    <link href="https://biglorange.github.io/disable_inner_keyboard_when_extkeyboard_plugged/"/>
    <id>https://biglorange.github.io/disable_inner_keyboard_when_extkeyboard_plugged/</id>
    <published>2018-11-13T04:31:33.000Z</published>
    <updated>2020-08-18T16:08:52.512Z</updated>
    
    <content type="html"><![CDATA[<p>起因</p><p>在 B 站看到一期视频<a href="https://www.bilibili.com/video/av22403776?t=174" target="_blank" rel="noopener">禁用笔记本内置键盘</a>，感觉手动操作还是有一点麻烦，所以写了一个小的 shell 脚本，在 zsh 中设置 alias 别名使用，但还是觉得有一些麻烦，改进了第二版，对是否插着外接键盘进行判断，再进行禁用，第三版目标，实现自动化</p><p>第一版</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/bash</span></span><br><span class="line">id=$(xinput | grep AT | cut -c53-54)</span><br><span class="line">xinput <span class="built_in">set</span>-prop <span class="variable">$id</span> <span class="string">"Device Enabled"</span> 0</span><br></pre></td></tr></table></figure><p>第二版</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/bash</span></span><br><span class="line"><span class="comment">#echo $1</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">"disable"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">usbkeyboard=<span class="string">''</span></span><br><span class="line">usbkeyboard=$(xinput | grep <span class="string">"USB Keyboard"</span> | sed -n <span class="string">'2p'</span>)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$usbkeyboard</span>"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"USB Keyboard Plugged"</span></span><br><span class="line">id=$(xinput | grep AT | cut -c53-54)</span><br><span class="line">xinput <span class="built_in">set</span>-prop <span class="variable">$id</span> <span class="string">"Device Enabled"</span> 0</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Inner Keyboard disabled"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">" USB Keyboard NOT Plugged,please check!"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">"enable"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">id=$(xinput | grep AT | cut -c53-54)</span><br><span class="line">xinput <span class="built_in">set</span>-prop <span class="variable">$id</span> <span class="string">"Device Enabled"</span> 1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Inner Keyboard enabled"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>第三版</p><p>使用 udev 规则进行触发脚本</p><h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a href="https://segmentfault.com/a/1190000011010908" target="_blank" rel="noopener">Linux Udev</a></p><p><a href="https://winddoing.github.io/post/3820.html" target="_blank" rel="noopener">udev 的使用</a></p><p><a href="http://www.xzcblog.com/post-266.html" target="_blank" rel="noopener">通过udev自动检测外置键盘并开启关闭内置键盘</a></p><p><a href="https://harttle.land/2013/10/27/synaptics-settings-linux.html" target="_blank" rel="noopener">外接鼠标禁用触摸板</a></p>]]></content>
    
    <summary type="html">
    
      在外接键盘时禁用笔记本内置键盘，防止误触
    
    </summary>
    
    
      <category term="script" scheme="https://biglorange.github.io/categories/script/"/>
    
      <category term="shell" scheme="https://biglorange.github.io/categories/script/shell/"/>
    
    
      <category term="linux" scheme="https://biglorange.github.io/tags/linux/"/>
    
      <category term="script" scheme="https://biglorange.github.io/tags/script/"/>
    
      <category term="shell" scheme="https://biglorange.github.io/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>Fail2ban 在服务器上的配置</title>
    <link href="https://biglorange.github.io/Fail2ban/"/>
    <id>https://biglorange.github.io/Fail2ban/</id>
    <published>2018-11-10T14:18:34.000Z</published>
    <updated>2020-08-20T13:24:29.811Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装 fail2ban mailx sendmail</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>配置 fail2ban jail 部分</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/fail2ban/jail/<span class="built_in">local</span></span><br><span class="line">DEFAULT]</span><br><span class="line"><span class="comment"># 以空格分隔的列表，可以是 IP 地址、CIDR 前缀或者 DNS 主机名</span></span><br><span class="line"><span class="comment"># 用于指定哪些地址可以忽略 fail2ban 防御</span></span><br><span class="line">ignoreip = 127.0.0.1 172.31.0.0/24 10.10.0.0/24 192.168.0.0/24</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 客户端主机被禁止的时长（秒）</span></span><br><span class="line">bantime = 864000</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 客户端主机被禁止前允许失败的次数 </span></span><br><span class="line">maxretry = 3</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查找失败次数的时长（秒）</span></span><br><span class="line">findtime = 600</span><br><span class="line"> </span><br><span class="line">mta = mailx</span><br><span class="line"></span><br><span class="line">destemail=orange804072060@gmail.com</span><br><span class="line"><span class="comment">#sendmail-whois[name=SSH, dest=orange804072060@gmail.com, sender=orange804072060@163.com]</span></span><br><span class="line"> </span><br><span class="line">[ssh-iptables]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">filter = sshd</span><br><span class="line">action = iptables[name=SSH, port=10881, protocol=tcp]</span><br><span class="line"> mail-whois[name=SSH, dest=orange804072060@gmail.com]</span><br><span class="line"><span class="comment"># sendmail-whois[name=SSH, dest=your@email.com, sender=fail2ban@email.com]</span></span><br><span class="line"><span class="comment"># Debian 系的发行版 </span></span><br><span class="line"><span class="comment"># logpath = /var/log/auth.log</span></span><br><span class="line"><span class="comment"># Red Hat 系的发行版</span></span><br><span class="line">logpath = /var/<span class="built_in">log</span>/secure</span><br><span class="line"><span class="comment"># ssh 服务的最大尝试次数 </span></span><br><span class="line">maxretry = 3</span><br></pre></td></tr></table></figure><p>配置邮件服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/mail.rc</span><br><span class="line"><span class="built_in">set</span> from=username@domain.com</span><br><span class="line"><span class="built_in">set</span> smtp=smtp.163.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=username@domain.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-password=passwd</span><br><span class="line"><span class="built_in">set</span> smtp-use-starttls</span><br><span class="line"><span class="built_in">set</span> smtp-auth=login</span><br><span class="line"><span class="built_in">set</span> ssl-verify=ignore</span><br><span class="line"><span class="built_in">set</span> nss-config-dir=/home/orange/</span><br></pre></td></tr></table></figure><p>开放 tcp 25端口 / 465  端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/fail2ban/fail2ban.git</span><br><span class="line"><span class="comment">## 下载源码，复制 mail-whois.conf 文件</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制 mail-whois.conf 到  /etc/fail2ban/action.d/mail-whois.conf</span><br></pre></td></tr></table></figure><p>修改 mail-whois.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/fail2ban/action.d/mail-whois.conf</span><br><span class="line"><span class="comment"># mail 全部替换为 mailx 所在的绝对路径</span></span><br><span class="line"><span class="comment"># Fail2Ban configuration file</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: Cyril Jaquier</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[INCLUDES]</span><br><span class="line"></span><br><span class="line">before = mail-whois-common.conf</span><br><span class="line"></span><br><span class="line">[Definition]</span><br><span class="line"></span><br><span class="line"><span class="comment"># bypass ban/unban for restored tickets</span></span><br><span class="line">norestored = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Option:  actionstart</span></span><br><span class="line"><span class="comment"># Notes.:  command executed on demand at the first ban (or at the start of Fail2Ban if actionstart_on_demand is set to false).</span></span><br><span class="line"><span class="comment"># Values:  CMD</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">actionstart = <span class="built_in">printf</span> %%b <span class="string">"Hi,\n</span></span><br><span class="line"><span class="string">              The jail &lt;name&gt; has been started successfully.\n</span></span><br><span class="line"><span class="string">              Regards,\n</span></span><br><span class="line"><span class="string">              Fail2Ban"</span>|/usr/bin/mailx -s <span class="string">"[Fail2Ban] &lt;name&gt;: started on &lt;fq-hostname&gt;"</span> &lt;dest&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Option:  actionstop</span></span><br><span class="line"><span class="comment"># Notes.:  command executed at the stop of jail (or at the end of Fail2Ban)</span></span><br><span class="line"><span class="comment"># Values:  CMD</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">actionstop = <span class="built_in">printf</span> %%b <span class="string">"Hi,\n</span></span><br><span class="line"><span class="string">             The jail &lt;name&gt; has been stopped.\n</span></span><br><span class="line"><span class="string">             Regards,\n</span></span><br><span class="line"><span class="string">             Fail2Ban"</span>|/usr/bin/mailx -s <span class="string">"[Fail2Ban] &lt;name&gt;: stopped on &lt;fq-hostname&gt;"</span> &lt;dest&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Option:  actioncheck</span></span><br><span class="line"><span class="comment"># Notes.:  command executed once before each actionban command</span></span><br><span class="line"><span class="comment"># Values:  CMD</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">actioncheck = </span><br><span class="line"></span><br><span class="line"><span class="comment"># Option:  actionban</span></span><br><span class="line"><span class="comment"># Notes.:  command executed when banning an IP. Take care that the</span></span><br><span class="line"><span class="comment">#          command is executed with Fail2Ban user rights.</span></span><br><span class="line"><span class="comment"># Tags:    See jail.conf(5) man page</span></span><br><span class="line"><span class="comment"># Values:  CMD</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">actionban = <span class="built_in">printf</span> %%b <span class="string">"Hi,\n</span></span><br><span class="line"><span class="string">            The IP &lt;ip&gt; has just been banned by Fail2Ban after</span></span><br><span class="line"><span class="string">            &lt;failures&gt; attempts against &lt;name&gt;.\n\n</span></span><br><span class="line"><span class="string">            Here is more information about &lt;ip&gt; :\n</span></span><br><span class="line"><span class="string">            `%(_whois_command)s`\n</span></span><br><span class="line"><span class="string">            Regards,\n</span></span><br><span class="line"><span class="string">            Fail2Ban"</span>|/usr/bin/mailx -s <span class="string">"[Fail2Ban] &lt;name&gt;: banned &lt;ip&gt; from &lt;fq-hostname&gt;"</span> &lt;dest&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Option:  actionunban</span></span><br><span class="line"><span class="comment"># Notes.:  command executed when unbanning an IP. Take care that the</span></span><br><span class="line"><span class="comment">#          command is executed with Fail2Ban user rights.</span></span><br><span class="line"><span class="comment"># Tags:    See jail.conf(5) man page</span></span><br><span class="line"><span class="comment"># Values:  CMD</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">actionunban = </span><br><span class="line"></span><br><span class="line">[Init]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Default name of the chain</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">name = default</span><br><span class="line"></span><br><span class="line"><span class="comment"># Destination/Addressee of the mail</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">dest = root</span><br></pre></td></tr></table></figure><p>应用 fail2ban  服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable fail2ban</span><br><span class="line">sudo systemctl start fail2ban</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Fail2ban 安装及配置
    
    </summary>
    
    
      <category term="fail2ban" scheme="https://biglorange.github.io/categories/fail2ban/"/>
    
    
      <category term="fail2ban" scheme="https://biglorange.github.io/tags/fail2ban/"/>
    
      <category term="linux" scheme="https://biglorange.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>显卡驱动作死，使用 nvidia-prime 管理显卡</title>
    <link href="https://biglorange.github.io/use_nvidia_prime_to_control_nvidia_card/"/>
    <id>https://biglorange.github.io/use_nvidia_prime_to_control_nvidia_card/</id>
    <published>2018-10-29T10:14:15.000Z</published>
    <updated>2020-08-20T13:23:01.332Z</updated>
    
    <content type="html"><![CDATA[<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>由于是本来就能使用 bumblebee ，所以只是卸载掉 bumblebee 之后安装nvidia-prime。</p><p>系统版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">                  -`                    orange@BiGOranGe </span><br><span class="line">                 .o+`                   ---------------- </span><br><span class="line">                `ooo/                   OS: Arch Linux x86_64 </span><br><span class="line">               `+oooo:                  Host: Aspire VN7-591G V1.15 </span><br><span class="line">              `+oooooo:                 Kernel: 4.18.16-arch1-1-ARCH </span><br><span class="line">              -+oooooo+:                Uptime: 9 mins </span><br><span class="line">            `/:-:++oooo+:               Packages: 1852 (pacman) </span><br><span class="line">           `/++++/+++++++:              Shell: zsh 5.6.2 </span><br><span class="line">          `/++++++++++++++:             Resolution: 1920x1080 </span><br><span class="line">         `/+++ooooooooooooo/`           DE: Deepin </span><br><span class="line">        ./ooosssso++osssssso+`          WM: Mutter(DeepinGala) </span><br><span class="line">       .oossssso-````/ossssss+`         Theme: Adapta-Nokto [GTK2/3] </span><br><span class="line">      -osssssso.      :ssssssso.        Icons: Numix-Circle [GTK2/3] </span><br><span class="line">     :osssssss/        osssso+++.       Terminal: deepin-terminal </span><br><span class="line">    /ossssssss/        +ssssooo/-       Terminal Font: Noto Mono for Powerline 11 </span><br><span class="line">  `/ossssso+/:-        -:/+osssso+-     CPU: Intel i5-4210H (4) @ 3.500GHz </span><br><span class="line"> `+sso+:-`                 `.-/+oso:    GPU: Intel 4th Gen Core Processor </span><br><span class="line">`++:.                           `-/+/   GPU: NVIDIA GeForce GTX 860M </span><br><span class="line">.`                                 `/   Memory: 2926MiB / 7899MiB</span><br></pre></td></tr></table></figure><p>nvidia 版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Mon Oct 29 18:37:30 2018       </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 410.66       Driver Version: 410.66       CUDA Version: 10.0     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  GeForce GTX 860M    Off  | 00000000:01:00.0 Off |                  N/A |</span><br><span class="line">| N/A   49C    P8    N/A /  N/A |    640MiB /  2004MiB |      7%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">                                                                               </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                       GPU Memory |</span><br><span class="line">|  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0       549      G   /usr/lib/Xorg                                258MiB |</span><br><span class="line">|    0       674      G   deepin-wm                                    216MiB |</span><br><span class="line">|    0      1546      G   ...ge/.local/share/Steam/ubuntu12_32/steam    37MiB |</span><br><span class="line">|    0      1555      G   ./steamwebhelper                               2MiB |</span><br><span class="line">|    0      3683      G   ...uest-channel-token=16256402389774494101    94MiB |</span><br><span class="line">|    0      4595      G   ...-token=D2D86F812F487F5D39D0389BF2F103BD    25MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>桌面环境(DDE)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepin desktop environment</span><br></pre></td></tr></table></figure><p>卸载 bumblebee</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yaourt -Rnsc bumblebee</span><br></pre></td></tr></table></figure><h3 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h3><p>如果是全新安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yaourt -S nvidia nvidia-utils xorg-xrandr</span><br></pre></td></tr></table></figure><p>配置 /etc/X11/xorg.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Section <span class="string">"Module"</span></span><br><span class="line">    Load <span class="string">"modesetting"</span></span><br><span class="line">EndSection</span><br><span class="line">Section <span class="string">"Device"</span></span><br><span class="line">    Identifier <span class="string">"nvidia"</span></span><br><span class="line">    Driver <span class="string">"nvidia"</span></span><br><span class="line">    BusID <span class="string">"PCI:1:0:0"</span>  <span class="comment">#BusID</span></span><br><span class="line">    Option <span class="string">"AllowEmptyInitialConfiguration"</span></span><br><span class="line">    Option <span class="string">"OnDemandVBlankInterrupts"</span> <span class="string">"1"</span></span><br><span class="line">    Option <span class="string">"NoLogo"</span> <span class="string">"1"</span></span><br><span class="line">    Option <span class="string">"RenderAccel"</span> <span class="string">"1"</span></span><br><span class="line">    <span class="comment"># Option "TripleBuffer" "1"</span></span><br><span class="line">    <span class="comment"># 强制Powermizer任何时间都在在特定级别</span></span><br><span class="line">    <span class="comment"># level 0x1=highest</span></span><br><span class="line">    <span class="comment"># level 0x2=med</span></span><br><span class="line">    <span class="comment"># level 0x3=lowest</span></span><br><span class="line">    <span class="comment"># 交流电源设置：</span></span><br><span class="line">    <span class="comment"># Option "RegistryDwords" "PowerMizerLevelAC=0x3"</span></span><br><span class="line">    <span class="comment"># Option "Coolbits" "1"</span></span><br><span class="line">EndSection</span><br><span class="line">Section <span class="string">"Device"</span></span><br><span class="line">    Identifier  <span class="string">"intel"</span></span><br><span class="line">    Driver      <span class="string">"modesetting"</span></span><br><span class="line">    BusID       <span class="string">"PCI:0:2:0"</span></span><br><span class="line">    Option      <span class="string">"AccelMethod"</span>  <span class="string">"sna"</span></span><br><span class="line">    <span class="comment">#Option      "TearFree" "True"</span></span><br><span class="line">    <span class="comment">#Option      "Tiling" "True"</span></span><br><span class="line">    <span class="comment">#Option      "SwapbuffersWait" "True"</span></span><br><span class="line">EndSection</span><br><span class="line">Section <span class="string">"ServerLayout"</span></span><br><span class="line">    Identifier <span class="string">"layout"</span></span><br><span class="line">    <span class="comment">#Screen 1 "nvidia"</span></span><br><span class="line">    Inactive <span class="string">"intel"</span></span><br><span class="line">EndSection</span><br></pre></td></tr></table></figure><p>其中 BusID 必须和 lspci 命令输出相匹配</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lspci | grep 3D</span><br><span class="line">01:00.0 3D controller: NVIDIA Corporation GM107M [GeForce GTX 860M] (rev a2)</span><br></pre></td></tr></table></figure><p>BusID 由 lspci 输出 01:00.00 转换而来，转换结果： 1:0:0</p><p>使用显示管理器 (Display Manager, DM) ，需要编辑启动管理脚本来使用 nvidia 显卡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/lightdm/display_setup.sh</span><br><span class="line">xrandr --setprovideroutputsource modesetting NVIDIA-0</span><br><span class="line">xrandr --auto</span><br><span class="line">xrandr --dpi 99 <span class="comment">#官方 wiki 参数为 96，个人电脑 96 浏览器字体模糊，修改为 99 个人使用良好</span></span><br></pre></td></tr></table></figure><p>赋予脚本可执行权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/lightdm/display_setup.sh</span><br></pre></td></tr></table></figure><p>编辑 <code>/etc/lightdm/lightdm.conf</code> 的 <code>[Seat:*]</code> 部分以配置 lightdm 运行这个脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/lightdm/lightdm.conf</span><br><span class="line">[Seat:*]</span><br><span class="line">display-setup-script=/etc/lightdm/display_setup.sh</span><br></pre></td></tr></table></figure><p>其他显示管理器修改方式： <a href="https://wiki.archlinux.org/index.php/NVIDIA_Optimus_\(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87\)" target="_blank" rel="noopener">NVIDIA Optimus</a></p><p>重启即可应用。</p><h3 id="性能检验"><a href="#性能检验" class="headerlink" title="性能检验"></a>性能检验</h3><p>古墓丽影 9 帧数提升明显</p><p>使用 bumblebee 时忘记截图了，最低27，最高 40左右，平均在30帧附近</p><p>使用 nvidia-prime ，帧数</p><table><thead><tr><th></th><th>帧数</th></tr></thead><tbody><tr><td>最低</td><td>33</td></tr><tr><td>最高</td><td>68</td></tr><tr><td>平均</td><td>55.1</td></tr></tbody></table><p><img src="/.io//DeepinScreenshot_TombRaider_20181029194600.png" alt="DeepinScreenshot_TombRaider_20181029194600"></p><p>画面配置详情</p><p><img src="/.io//DeepinScreenshot_TombRaider_20181029194636.png" alt="DeepinScreenshot_TombRaider_20181029194636.png"></p><p><img src="/.io//DeepinScreenshot_TombRaider_20181029194654.png" alt="DeepinScreenshot_TombRaider_20181029194654.png"></p><p>系统主要硬件信息</p><table><thead><tr><th>硬件</th><th>型号</th></tr></thead><tbody><tr><td>CPU</td><td>i5-4210HQ</td></tr><tr><td>GPU</td><td>GTX860M</td></tr><tr><td>RAM</td><td>DDR3L 8G</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      emmm，本来 bumblebee 使用的挺好的，但是 optirun 游戏性能很捉急，所以冲动之下换成 nvidia-prime 驱动显卡。
    
    </summary>
    
    
      <category term="nVidia" scheme="https://biglorange.github.io/categories/nVidia/"/>
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/categories/nVidia/Arch-Linux/"/>
    
    
      <category term="Arch Linux" scheme="https://biglorange.github.io/tags/Arch-Linux/"/>
    
      <category term="nvidia" scheme="https://biglorange.github.io/tags/nvidia/"/>
    
      <category term="nvidia-primes" scheme="https://biglorange.github.io/tags/nvidia-primes/"/>
    
      <category term="bumblebee" scheme="https://biglorange.github.io/tags/bumblebee/"/>
    
  </entry>
  
</feed>
